<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Clients - Reflexofeu</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 700;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }

        .upload-section.dragging {
            background: #e8eaff;
            border-color: #764ba2;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .preview-section {
            margin-top: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr.selected {
            background: #e8eaff;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .message {
            padding: 15px 20px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 60px 20px;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Import des Clients</h1>

        <div class="upload-section" id="dropZone">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 20px; opacity: 0.5;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <p style="font-size: 18px; color: #333; margin-bottom: 10px;">
                Glissez-d√©posez votre fichier Excel ici
            </p>
            <p style="color: #6c757d; margin-bottom: 20px;">
                ou
            </p>
            <label for="fileInput" class="btn">
                Choisir un fichier
            </label>
            <input type="file" id="fileInput" accept=".xls,.xlsx">
        </div>

        <div id="previewSection" class="preview-section" style="display: none;">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalClients">0</div>
                    <div class="stat-label">Clients trouv√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="selectedClients">0</div>
                    <div class="stat-label">Clients s√©lectionn√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="validClients">0</div>
                    <div class="stat-label">Clients valides</div>
                </div>
            </div>

            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn" id="selectAllBtn">Tout s√©lectionner</button>
                <button class="btn btn-secondary" id="deselectAllBtn">Tout d√©s√©lectionner</button>
                <button class="btn" id="importBtn" disabled>Importer les clients s√©lectionn√©s</button>
            </div>

            <div id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar">0%</div>
                </div>
            </div>

            <div id="messages"></div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAllCheckbox" class="checkbox">
                            </th>
                            <th>Nom</th>
                            <th>Adresse</th>
                            <th>Code postal</th>
                            <th>Ville</th>
                            <th>T√©l√©phone</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://luaiyowmrtxtplvundfs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1YWl5b3dtcnR4dHBsdnVuZGZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MDg2NzIsImV4cCI6MjA4MTk4NDY3Mn0.Nn60UBu9yEy8YvqxfiAUFDFUYnGHw_ZtdXVsxqWws6w';

        let supabase;
        let clientsData = [];
        let selectedIndices = new Set();

        // Initialiser Supabase
        async function initSupabase() {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                showMessage('Erreur: Les informations de connexion Supabase sont manquantes', 'error');
                return false;
            }

            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // V√©rifier l'authentification
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    showMessage('‚ö†Ô∏è Vous devez √™tre connect√© pour importer des clients. Redirection...', 'error');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return false;
                }

                return true;
            } catch (error) {
                showMessage('Erreur lors de l\'initialisation: ' + error.message, 'error');
                return false;
            }
        }

        // Initialiser au chargement
        (async () => {
            const initialized = await initSupabase();
            if (!initialized) {
                document.getElementById('importBtn').disabled = true;
            }
        })();

        // Drag and drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragging');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragging');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragging');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    processExcelData(jsonData);
                } catch (error) {
                    showMessage('Erreur lors de la lecture du fichier: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            clientsData = data.map((row, index) => ({
                index,
                nom: row['Raison sociale'] || row['Client'] || '',
                adresse: row['Adresse'] || '',
                adresse2: row['Adresse compl√©mentaire (2√®me ligne)'] || null,
                code_postal: row['Code postal'] ? String(row['Code postal']) : '',
                ville: row['Ville'] || '',
                contact: null,
                telephone: row['T√©l√©phone'] || row['Mobile'] || null,
                email: row['Email'] || null,
                multi_site: false,
                valid: validateClient(row)
            })).filter(client => client.nom); // Filtrer les lignes vides

            displayClients();
            updateStats();
        }

        function validateClient(row) {
            const nom = row['Raison sociale'] || row['Client'] || '';
            const adresse = row['Adresse'] || '';
            const codePostal = row['Code postal'] ? String(row['Code postal']) : '';
            const ville = row['Ville'] || '';

            return nom && adresse && codePostal && ville;
        }

        function displayClients() {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';

            clientsData.forEach((client, index) => {
                const tr = document.createElement('tr');
                tr.className = client.valid ? '' : 'invalid';
                if (selectedIndices.has(index)) {
                    tr.classList.add('selected');
                }

                tr.innerHTML = `
                    <td>
                        <input type="checkbox"
                               class="checkbox client-checkbox"
                               data-index="${index}"
                               ${selectedIndices.has(index) ? 'checked' : ''}>
                    </td>
                    <td>${client.nom}</td>
                    <td>${client.adresse}${client.adresse2 ? '<br><small>' + client.adresse2 + '</small>' : ''}</td>
                    <td>${client.code_postal}</td>
                    <td>${client.ville}</td>
                    <td>${client.telephone || '-'}</td>
                    <td>${client.email || '-'}</td>
                `;

                tbody.appendChild(tr);
            });

            // Attacher les √©v√©nements
            document.querySelectorAll('.client-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
            });

            document.getElementById('previewSection').style.display = 'block';
        }

        function handleCheckboxChange(e) {
            const index = parseInt(e.target.dataset.index);
            if (e.target.checked) {
                selectedIndices.add(index);
            } else {
                selectedIndices.delete(index);
            }
            updateStats();
            updateImportButton();

            const tr = e.target.closest('tr');
            if (e.target.checked) {
                tr.classList.add('selected');
            } else {
                tr.classList.remove('selected');
            }
        }

        function updateStats() {
            document.getElementById('totalClients').textContent = clientsData.length;
            document.getElementById('selectedClients').textContent = selectedIndices.size;
            document.getElementById('validClients').textContent =
                clientsData.filter(c => c.valid).length;
        }

        function updateImportButton() {
            document.getElementById('importBtn').disabled = selectedIndices.size === 0;
        }

        document.getElementById('selectAllBtn').addEventListener('click', () => {
            selectedIndices.clear();
            clientsData.forEach((_, index) => selectedIndices.add(index));
            displayClients();
            updateStats();
            updateImportButton();
        });

        document.getElementById('deselectAllBtn').addEventListener('click', () => {
            selectedIndices.clear();
            displayClients();
            updateStats();
            updateImportButton();
        });

        document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
            if (e.target.checked) {
                selectedIndices.clear();
                clientsData.forEach((_, index) => selectedIndices.add(index));
            } else {
                selectedIndices.clear();
            }
            displayClients();
            updateStats();
            updateImportButton();
        });

        document.getElementById('importBtn').addEventListener('click', async () => {
            if (!supabase) {
                showMessage('Erreur: Connexion Supabase non initialis√©e', 'error');
                return;
            }

            const selectedClients = Array.from(selectedIndices)
                .map(index => clientsData[index])
                .filter(client => client.valid);

            if (selectedClients.length === 0) {
                showMessage('Aucun client valide s√©lectionn√©', 'error');
                return;
            }

            await importClients(selectedClients);
        });

        async function importClients(clients) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const importBtn = document.getElementById('importBtn');

            progressContainer.style.display = 'block';
            importBtn.disabled = true;

            try {
                // R√©cup√©rer le token d'authentification
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    throw new Error('Non authentifi√©');
                }

                // Pr√©parer les donn√©es
                const clientsToImport = clients.map(client => ({
                    nom: client.nom,
                    adresse: client.adresse,
                    adresse2: client.adresse2,
                    code_postal: client.code_postal,
                    ville: client.ville,
                    contact: client.contact,
                    telephone: client.telephone,
                    email: client.email,
                    multi_site: client.multi_site
                }));

                // Animation de progression
                progressBar.style.width = '50%';
                progressBar.textContent = 'Import en cours...';

                // Appeler l'Edge Function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/import-clients`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ clients: clientsToImport })
                });

                progressBar.style.width = '100%';
                progressBar.textContent = '100%';

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur lors de l\'import');
                }

                const result = await response.json();

                progressContainer.style.display = 'none';
                importBtn.disabled = false;

                // Afficher les r√©sultats
                if (result.errors && result.errors.length > 0) {
                    showMessage(`‚úÖ ${result.imported} client(s) import√©(s) sur ${result.total}`, 'success');
                    showMessage(`‚ö†Ô∏è ${result.errors.length} erreur(s): ${result.errors.slice(0, 3).map(e => e.client).join(', ')}${result.errors.length > 3 ? '...' : ''}`, 'error');
                } else {
                    showMessage(`‚úÖ ${result.imported} client(s) import√©(s) avec succ√®s!`, 'success');
                }

                // R√©initialiser la s√©lection
                selectedIndices.clear();
                displayClients();
                updateStats();
                updateImportButton();

            } catch (error) {
                console.error('Erreur import:', error);
                progressContainer.style.display = 'none';
                importBtn.disabled = false;
                showMessage(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        function showMessage(text, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
